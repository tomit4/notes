(()=>{"use strict";const e="mnojpmjdmbbfmejpflffifhffcmidifd";let t=null;const r=()=>t,n=(e,t)=>e&&t?`${e}_${t}`:"",o=(e,t)=>`${e}#channel:${t}`,i=(e,t,r)=>{if(e.length<t.length)return"";const n=e.indexOf(t);if(-1===n)return"";const o=n+t.length,i=e.indexOf(r,o);let a="";return i!==o?a=-1!==i&&i>o||-1!==i?e.substring(o,i):e.substring(o):""===r&&(a=e.substring(o)),a},a=(e,t)=>`${e}: ${t.statusText} (${t.status})`,s={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},c=/&(?:amp|lt|gt|quot|#(0+)?39);/g,u=RegExp(c.source),l="youtube",h="youtube.com",d=e=>`https://www.youtube.com/channel/${e}/videos`,m=e=>{if(!e)return"";let t=i(e,'"avatar":{"thumbnails":[{"url":"','"');return t||(t=i(e,'"width":88,"height":88},{"url":"','"'),t||"")},f=e=>{if(!e)return"";let t=i(e,'"ucid":"','"');return t||(t=i(e,'HeaderRenderer":{"channelId":"','"'),t||(t=i(e,'<link rel="canonical" href="https://www.youtube.com/channel/','">'),t||(t=i(e,'browseEndpoint":{"browseId":"','"'),t||"")))},p=()=>document.querySelector("#contents .ytp-title-link"),w=e=>{if(!e||!e.href)return"";const t=new URL(e.href);return t?b(t):""},b=e=>{if(!e)return"";const t=new URLSearchParams(e.search);return t&&t.get("v")||""},y=e=>!(!e||!e.includes("/channel/")),v=e=>!(!e||!e.includes("/user/")),g=async()=>{const e=location.href,t=await fetch(e);if(!t.ok){const e=a("Publisher request failed",t);throw new Error(e)}const r=await t.text(),h=f(r);if(!h)throw new Error("Invalid channel id");const b=o(l,h),y=(e=>{if(!e)return"";const t=i(e,'<meta itemprop="name" content="','"');return t?(r=t)&&u.test(r)?r.replace(c,(e=>s[e]||"'")):r||"":"";var r})(r);if(!y)throw new Error("Invalid publisher name");const v=p(),g=w(v),E=n(l,g||h),I=m(r);return{url:d(h),publisherKey:b,publisherName:y,mediaKey:E,favIconUrl:I}},E=(e,t,r,a)=>{const s=f(t);if(!s)throw new Error("Invalid channel id");const c=o(l,s),u=b(new URL(e));if(!u)throw new Error("Invalid media id");const h=n(l,u||s);if(!r&&!(r=(e=>{if(!e)return"";const t=i(e,'"author":"','"');if(!t)return"";let r=null;try{r=JSON.parse(`{"brave_publisher":"${t}"}`)}catch(e){throw new Error(`Error parsing publisher name from response: ${e}`)}return r.brave_publisher})(t)))throw new Error("Invalid publisher name");return a||(a=d(s)),{url:a,publisherKey:c,publisherName:r,mediaKey:h,favIconUrl:m(t)}},I=async()=>{if((e=location.pathname)&&e.endsWith("/watch"))return(async()=>{const e=location.href,t=b(new URL(e));if(!t)throw new Error("Invalid media id");const r=(e=>`https://www.youtube.com/watch?v=${e}`)(t),n=encodeURI(r),o=await fetch(`https://www.youtube.com/oembed?format=json&url=${n}`);if(!o.ok){if(401===o.status)return(async e=>{const t=await fetch(e);if(!t.ok){const e=a("Publisher request failed",t);throw new Error(e)}const r=await t.text();if(!r)throw new Error("Publisher request failed: empty response");return E(e,r,"","")})(e);{const e=a("oEmbed request failed",o);throw new Error(e)}}const i=await o.json(),s={};s.publisherUrl=i.author_url,s.publisherName=i.author_name;const c=await fetch(s.publisherUrl);if(!c.ok){const e=a("Publisher request failed",o);throw new Error(e)}const u=await c.text();if(!u)throw new Error("Publisher request failed: empty response");return E(e,u,s.publisherName,s.publisherUrl)})();var e;if(y(location.pathname)){const e=(e=>{if(!e)return"";const t=i(e+"/","/channel/","/");if(!t)return"";const r=t.split("?");return r&&0!==r.length?r[0]:""})(location.pathname);return(async e=>{if(!e)throw new Error("Invalid channel id");const t=document.querySelector("#channel-container #text-container");if(!t)throw new Error("Unable to extract channel name from page");const r=o(l,e),i=(a=t)?a.innerText.trim():"";var a;if(!i)throw new Error("Invalid publisher name");const s=p(),c=w(s),u=n(l,c||e);return{url:d(e),publisherKey:r,publisherName:i,mediaKey:u,favIconUrl:(e=>{for(const t of e){const e=m(t.text);if(e)return e}return""})(document.scripts)}})(e)}return v(location.pathname)?g():(e=>{const t=["/","/account","/account_advanced","/account_billing","/account_notifications","/account_playback","/account_privacy","/account_sharing","/channel","/feed","/gaming","/oops","/pair","/playlist","/premium","/reporthistory","/subscription_manager","/user","/watch"];if(!e)return!1;const r=(e=>{if(!e)return"";let t=e.substring(0,e.indexOf("/",1));return t&&t!==e||(t=e.substring(0,e.indexOf("?",1)),t&&t!==e||(t=e)),t})(e);for(const e of t)if(r===e)return!0;return!1})(location.pathname)?{url:"https://www.youtube.com",publisherKey:h,publisherName:h,mediaKey:"",favIconUrl:""}:g()};let x=0;const U=new Set,$=()=>{x=Date.now()};var _;chrome.extension.inIncognitoContext||(_=e=>{e?(document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState?$():(y(location.pathname)||v(location.pathname))&&I().then((e=>{const t=!U.has(e.mediaKey);t&&U.add(e.mediaKey);const o=e.mediaKey.replace("youtube_",""),i=Math.round((Date.now()-x)/1e3);((e,t,o,i)=>{if(!t)return;const a=r();a&&a.postMessage({type:"MediaDurationMetadata",mediaType:e,data:{mediaKey:n(e,t),duration:o,firstVisit:i}})})(l,o,i,t)})).catch((e=>{throw new Error(`Failed to retrieve publisher data: ${e}`)}))})),"visible"===document.visibilityState&&$(),document.addEventListener("yt-page-data-updated",(function(){$()}))):console.error("Failed to initialize communications port")},t?_(!0):(chrome.runtime.sendMessage(e,{type:"SupportsGreaselion"},(function(r){!chrome.runtime.lastError&&r&&r.supported&&(t=chrome.runtime.connect(e,{name:"Greaselion"}),_(!0))})),setTimeout((()=>{t||(t=chrome.runtime.connect("jidkidbbcafjabdphckchenhfomhnfma",{name:"Greaselion"}),_(!0))}),100)),console.info("Greaselion script loaded: youtubeAutoContribution.ts"))})();