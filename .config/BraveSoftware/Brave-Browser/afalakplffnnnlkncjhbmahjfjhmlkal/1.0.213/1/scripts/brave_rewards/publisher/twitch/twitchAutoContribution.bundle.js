(()=>{"use strict";const e="mnojpmjdmbbfmejpflffifhffcmidifd";let t=null;const i=()=>t,n="twitch",o="www.twitch.tv",r=()=>{const e=document.querySelector(".channel-info-content .tw-avatar [src]");return e&&e.getAttribute("src")||""},a=()=>document.querySelector("h1.tw-title"),s=()=>{const e=a();return e&&e.textContent||""},c=e=>e.replace(/^\/|\/[\s\S]*/g,""),d=new Set(["directory","downloads","jobs","p","search","turbo"]),u=()=>"videos"===c(location.pathname).toLowerCase(),l=e=>{if(!e)return"";const t=/^\/*videos\//i;if(t.test(location.pathname)){const i=location.pathname.replace(t,""),n=c(i);return n?`twitch_${e}_void_${n}`:""}return`twitch_${e}`},m=e=>e?`twitch#author:${e}`:"",h=()=>({mediaId:"",mediaKey:"",publisherUrl:"https://www.twitch.tv",publisherKey:o,publisherName:o,favIconUrl:""}),p=()=>{const e=(()=>{if(u()){const e=a();if(!e||!e.parentElement)return"";const t=e.parentElement.getAttribute("href");return t?c(t).toLowerCase():""}const e=c(location.pathname).toLowerCase();return d.has(e)?"":e})();return e?{mediaId:e,mediaKey:l(e),publisherUrl:`https://www.twitch.tv/${e}`,publisherKey:m(e),publisherName:s(),favIconUrl:r()}:h()},f=(e,t)=>e&&t?`${e}_${t}`:"";RegExp(/&(?:amp|lt|gt|quot|#(0+)?39);/g.source);let w=!1,b=0,v="";const y=new class{constructor(){this.previous=h()}async read(){let e=p();if(!e.mediaId&&!u())return this.previous=e,e;let{previous:t}=this;for(let i=0;i<5e3&&!(e.mediaId&&e.publisherName&&e.favIconUrl&&(e.mediaId&&t.mediaId===e.mediaId||e.publisherName!==t.publisherName&&e.favIconUrl!==t.favIconUrl));i+=250)await new Promise((e=>setTimeout(e,250))),e=p();return this.previous=e,e}},g=new Set,I=()=>{b=Date.now()},U=e=>{e&&(e.url||"complete"===e.status)&&location.href!==v&&(v=location.href,I())};var K;chrome.extension.inIncognitoContext||(K=e=>{e?(document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState?I():y.read().then((e=>{const t=!g.has(e.mediaKey);t&&g.add(e.mediaKey);const o=e.mediaKey.replace("twitch_",""),r=Math.round((Date.now()-b)/1e3);((e,t,n,o)=>{if(!t)return;const r=i();r&&r.postMessage({type:"MediaDurationMetadata",mediaType:e,data:{mediaKey:f(e,t),duration:n,firstVisit:o}})})(n,o,r,t)})).catch((e=>{throw new Error(`Failed to retrieve publisher data: ${e}`)}))})),"visible"===document.visibilityState&&I(),((e,t)=>{if(w)return;w=!0;const n=i();n&&(n.postMessage({type:"RegisterOnUpdatedTab",mediaType:e}),n.onMessage.addListener((function(e){e.data&&"OnUpdatedTab"===e.type&&t(e.data.changeInfo)})))})(n,U)):console.error("Failed to initialize communications port")},t?K(!0):(chrome.runtime.sendMessage(e,{type:"SupportsGreaselion"},(function(i){!chrome.runtime.lastError&&i&&i.supported&&(t=chrome.runtime.connect(e,{name:"Greaselion"}),K(!0))})),setTimeout((()=>{t||(t=chrome.runtime.connect("jidkidbbcafjabdphckchenhfomhnfma",{name:"Greaselion"}),K(!0))}),100)),console.info("Greaselion script loaded: twitchAutoContribution.ts"))})();